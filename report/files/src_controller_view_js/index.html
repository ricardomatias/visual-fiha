<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - src/controller/view.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>src/controller/view.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">69.84</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">562</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">44.75</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">5.20</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">&#039;use strict&#039;;
var View = require(&#039;./control-view&#039;);
var ViewSwitcher = require(&#039;ampersand-view-switcher&#039;);
var MIDIAccessView = require(&#039;./../midi/view&#039;);
var SignalsView = require(&#039;./../signal/signals-view&#039;);
var LayersView = require(&#039;./../layer/layers-view&#039;);
var SuggestionView = require(&#039;./suggestion-view&#039;);
var AudioSource = require(&#039;./audio-source-view&#039;);
var AceEditor = require(&#039;./ace-view&#039;);
var RegionView = require(&#039;./region-view&#039;);
var GistView = require(&#039;./gist-view&#039;);
var MappingsControlView = require(&#039;./../mapping/control-view&#039;);
var ControlScreenControls = require(&#039;./control-screen-controls-view&#039;);
var LocalforageView = require(&#039;./localforage-view&#039;);
var objectPath = require(&#039;./../object-path&#039;);
// var Timeline = require(&#039;./timeline-view&#039;);





var ControllerView = View.extend({
  initialize: function(options) {
    var controllerView = this;
    this.signals = options.signals;
    this.midi = options.midi;
    this.mappings = options.mappings;
    if (!this.router) {
      throw new Error(&#039;Missing router options for ControllerView&#039;);
    }

    this.listenTo(this.router, &#039;all&#039;, function(...args) {
      if (args[0].indexOf(&#039;app:&#039;) === 0) this.trigger(...args);
    });

    [
      &#039;minDecibels&#039;,
      &#039;maxDecibels&#039;,
      &#039;smoothingTimeConstant&#039;,
      &#039;fftSize&#039;
    ].forEach(function(name) {
      controllerView.on(&#039;change:&#039; + name, function () {
        if (!controllerView.audioAnalyser) return;
        controllerView.audioAnalyser[name] = controllerView[name];
      });
    }, controllerView);


    controllerView._animate();

    if (options.autoStart) {
      controllerView.play();
    }

    if (controllerView.el) {
      controllerView._attachSuggestionHelper();
    }
    else {
      controllerView.once(&#039;change:el&#039;, controllerView._attachSuggestionHelper);
    }

    controllerView.listenTo(controllerView.model.layers, &#039;sendCommand&#039;, function(...args) {
      controllerView.sendCommand(...args);
    });

    this._animate();
  },

  midiSources: function() {
    var eventNames = [];
    this.midi.inputs.forEach(function(midiInput) {
      var id = midiInput.getId();
      eventNames = eventNames.concat(midiInput.mappable.source.map(function(property) {
        return &#039;midi:&#039; + id + &#039;.&#039; + property;
      }));
    });
    return eventNames;
  },

  sendCommand: function(name, payload, callback) {
    if (!this.router || !this.router.worker) return;
    this.router.sendCommand(name, payload, callback);
    return this;
  },

  _animate: function(timestamp) {
    if (this.controllerSparkline) {
      this.controllerSparkline.update(1000 / ((timestamp - this.model.frametime) - this.model.firstframetime));
    }

    if (this.audioSource) {
      this.audioSource.update();
    }

    this.model.frametime = timestamp - this.model.firstframetime;
    this.update();

    this._arId = window.requestAnimationFrame(this._animate.bind(this));
  },

  update: function() {
    var analyser = this.audioAnalyser;

    var freqArray = this.audioFrequencyArray;
    analyser.getByteFrequencyData(freqArray);

    var timeDomainArray = this.audioTimeDomainArray;
    analyser.getByteTimeDomainData(timeDomainArray);

    var command = {
      frametime: this.model.frametime,
      audio: {
        bufferLength: analyser.frequencyBinCount,
        frequency: freqArray,
        timeDomain: timeDomainArray
      }
    };

    this.sendCommand(&#039;heartbeat&#039;, command);
  },

  derived: {
    audioContext: {
      deps: [],
      fn: function() {
        return new window.AudioContext();
      }
    },
    audioAnalyser: {
      deps: [&#039;audioContext&#039;],
      fn: function() {
        var analyser = this.audioContext.createAnalyser();
        try {
          analyser.minDecibels = this.minDecibels;
          analyser.maxDecibels = this.maxDecibels;
          analyser.smoothingTimeConstant = this.smoothingTimeConstant;
          analyser.fftSize = this.fftSize;
        }
        catch (e) {}
        return analyser;
      }
    },
    audioFrequencyArray: {
      deps: [&#039;audioAnalyser&#039;, &#039;fftSize&#039;],
      fn: function () {
        return new window.Uint8Array(this.audioAnalyser.frequencyBinCount);
      }
    },
    audioTimeDomainArray: {
      deps: [&#039;audioAnalyser&#039;, &#039;fftSize&#039;],
      fn: function () {
        return new window.Uint8Array(this.audioAnalyser.frequencyBinCount);
      }
    },
    computedStyle: {
      deps: [&#039;el&#039;],
      fn: function() {
        return window.getComputedStyle(this.el);
      }
    }
  },

  session: {
    _arId: &#039;number&#039;,
    broadcastId: [&#039;string&#039;, true, &#039;vfBus&#039;],
    currentDetails: &#039;state&#039;,
    fftSize: [&#039;number&#039;, true, 256],
    maxDecibels: [&#039;number&#039;, true, -10],
    minDecibels: [&#039;number&#039;, true, -90],
    playing: [&#039;boolean&#039;, true, false],
    router: &#039;any&#039;,
    showControlScreen: [&#039;boolean&#039;, true, false],
    controlScreenWidth: [&#039;number&#039;, true, 33],
    controlScreenHeight: [&#039;number&#039;, true, 33],
    smoothingTimeConstant: [&#039;number&#039;, true, 0.85],
    workerPerformance: &#039;string&#039;
  },

  play: function() {
    this.playing = true;
    if (!this.model.firstframetime) {
      this.model.firstframetime = performance.now();
    }
    return this;
  },
  pause: function() {
    this.playing = false;
    return this;
  },
  stop: function() {
    this.playing = false;
    this.model.firstframetime = this.model.frametime = 0;
    return this;
  },

  subviews: {
    controlScreenControls: {
      waitFor: &#039;el&#039;,
      selector: &#039;.control-screen-controls&#039;,
      prepareView: function(el) {
        if (this.router) {
          this.set({
            showControlScreen: this.router.settings.get(&#039;showControlScreen&#039;, true),
            controlScreenWidth: this.router.settings.get(&#039;controlScreenWidth&#039;, 45),
            controlScreenHeight: this.router.settings.get(&#039;controlScreenHeight&#039;, 45)
          });
        }

        var view = new ControlScreenControls({
          el: el,
          active: this.showControlScreen,
          width: this.controlScreenWidth,
          height: this.controlScreenHeight,
          parent: this
        });

        this.listenToAndRun(view, &#039;change:active&#039;, function() {
          this.showControlScreen = view.active;
          if (this.router) {
            this.router.settings.set(&#039;showControlScreen&#039;, this.showControlScreen);
          }
        });
        this.listenToAndRun(view, &#039;change:width&#039;, function() {
          this.controlScreenWidth = view.width;
          if (this.router) {
            this.router.settings.set(&#039;controlScreenWidth&#039;, this.controlScreenWidth);
          }
        });
        this.listenToAndRun(view, &#039;change:height&#039;, function() {
          this.controlScreenHeight = view.height;
          if (this.router) {
            this.router.settings.set(&#039;controlScreenHeight&#039;, this.controlScreenHeight);
          }
        });
        return view;
      }
    },

    regionRight: {
      waitFor: &#039;el&#039;,
      selector: &#039;.region-right&#039;,
      prepareView: function(el) {
        var parent = this;
        function buildLayers() {
          if (parent.layersView &amp;&amp; parent.layersView.remove) {
            parent.layersView.remove();
            parent.stopListening(parent.layersView);
          }
          parent.layersView = new LayersView({
            collection: parent.model.layers,
            parent: parent,
            model: parent.model
          });
          return parent.layersView;
        }

        parent.mappingsView = new MappingsControlView({
          collection: parent.mappings,
          parent: parent,
          model: parent.model
        });

        function buildSignals() {
          if (parent.signalsView &amp;&amp; parent.signalsView.remove) {
            parent.signalsView.remove();
            parent.stopListening(parent.signalsView);
          }
          parent.signalsView = new SignalsView({
            collection: parent.signals,
            parent: parent,
            model: parent.model
          });
          return parent.signalsView;
        }

        function buildCodeEditor() {
          if (parent.codeEditor) {
            parent.stopListening(parent.codeEditor);
          }
          parent.codeEditor = new AceEditor({
            parent: parent
          });
          return parent.codeEditor;
        }

        var view = new RegionView({
          parent: parent,
          el: el,
          tabs: [
            {name: &#039;Layers&#039;, rebuild: buildLayers, pinned: true, active: true},
            {name: &#039;Signals&#039;, rebuild: buildSignals, pinned: true},
            {name: &#039;Mappings&#039;, view: parent.mappingsView, pinned: true},
            {name: &#039;Editor&#039;, rebuild: buildCodeEditor, pinned: true}
          ]
        });

        view.el.classList.add(&#039;region-right&#039;);
        view.el.classList.add(&#039;column&#039;);
        view.el.classList.add(&#039;rows&#039;);

        return view;
      }
    },

    regionLeftBottom: {
      waitFor: &#039;el&#039;,
      selector: &#039;.region-left-bottom&#039;,
      prepareView: function(el) {
        var parent = this;
        var styles = this.computedStyle;

        function buildAudioSource() {
          parent.audioSource = new AudioSource({
            audioAnalyser: parent.audioAnalyser,
            parent: parent,
            color: styles.color
          });
          return parent.audioSource;
        }
        buildAudioSource();

        if (parent.midi) {
          parent.MIDIAccess = new MIDIAccessView({
            parent: parent,
            model: parent.midi
          });
        }

        // parent.timeline = new Timeline({
        //   parent: this,
        //   entries: []
        // });

        var view = new RegionView({
          parent: parent,
          el: el,
          currentView: parent.mappingsView,
          tabs: [
            {name: &#039;MIDI&#039;, view: parent.MIDIAccess, pinned: true, active: true},
            {name: &#039;Audio&#039;, rebuild: buildAudioSource, pinned: true},
            // {name: &#039;Timeline&#039;, view: parent.timeline, pinned: true, active: true}
          ]
        });

        view.el.classList.add(&#039;row&#039;);
        view.el.classList.add(&#039;grow-l&#039;);
        view.el.classList.add(&#039;region-left-bottom&#039;);

        return view;
      }
    },

    localforageView: {
      waitFor: &#039;el&#039;,
      selector: &#039;.controller &gt; .header&#039;,
      prepareView: function(el) {
        var view = new LocalforageView({parent: this, model: this.model});
        el.appendChild(view.render().el);
        return view;
      }
    },

    gistView: {
      waitFor: &#039;el&#039;,
      selector: &#039;.controller &gt; .header&#039;,
      prepareView: function(el) {
        var view = new GistView({parent: this, model: this.model});
        el.appendChild(view.render().el);
        return view;
      }
    }
  },

  _attachSuggestionHelper: function() {
    if (this.suggestionHelper) { return; }
    this.suggestionHelper = this.registerSubview(new SuggestionView({
      parent: this
    }));
  },

  remove: function() {
    View.prototype.remove.apply(this, arguments);
  },

  bindings: {
    workerPerformance: &#039;.worker-performance&#039;,
    showControlScreen: [
      {
        selector: &#039;.control-screen&#039;,
        type: &#039;toggle&#039;
      },
      {
        selector: &#039;.control-screen&#039;,
        type: function(el, val) {
          el.src = !val ? &#039;&#039; : &#039;./screen.html#&#039; + this.broadcastId;
        }
      }
    ],
    controlScreenWidth: {
      selector: &#039;.region-left&#039;,
      type: function(el, val) {
        el.style.width = val +&#039;%&#039;;
      }
    },
    controlScreenHeight: {
      selector: &#039;.region-left-top&#039;,
      type: function(el, val) {
        var parentNode = el.parentNode;
        var height = ((Math.max(100, parentNode.clientHeight) / 100) * val) +&#039;px&#039;;
        el.style.maxHeight = height;
        el.style.minHeight = height;
      }
    },
    playing: [
      {
        type: &#039;toggle&#039;,
        selector: &#039;[name=&quot;play&quot;]&#039;,
        invert: true
      },
      {
        type: &#039;toggle&#039;,
        selector: &#039;[name=&quot;pause&quot;]&#039;
      }
    ]
  },

  commands: {
    &#039;click [name=&quot;play&quot;]&#039;: &#039;play&#039;,
    &#039;click [name=&quot;pause&quot;]&#039;: &#039;pause&#039;,
    &#039;click [name=&quot;stop&quot;]&#039;: &#039;stop&#039;
  },

  events: {
    &#039;click [name=&quot;screen&quot;]&#039;: &#039;_openScreen&#039;,
    &#039;click [name=&quot;setup-editor&quot;]&#039;: &#039;_setupEditor&#039;
  },

  _openScreen: function() {
    window.open(&#039;./screen.html#&#039; + this.broadcastId, &#039;screen&#039;, &#039;width=800,height=600,location=no&#039;);
  },

  toJSON: function() {
    return {
      signals: this.signals.toJSON(),
      mappings: this.mappings.toJSON(),
      layers: this.model.layers.toJSON()
    };
  },

  fromJSON: function(obj) {
    this.router._sendBootstrap(obj);
    return this;
  },



  getEditor: function() {
    this.regionRight.focusTab(&#039;Editor&#039;);
    return this.codeEditor;
  },

  _setupEditor: function() {
    var view = this;
    var editor = view.getEditor();

    editor.editCode({
      autoApply: false,
      title: &#039;Setup&#039;,
      script: view.gistView.toYaml(),
      language: &#039;yaml&#039;,
      onapply: function(str) {
        view.router._sendBootstrap(view.gistView.fromYaml(str), view._setupEditor.bind(view));
      }
    });
  },

  showDetails: function (view) {
    if (view === this.currentDetails) return this;
    var tabs = this.regionLeftBottom.tabs;
    var tabName = view.modelPath || objectPath(view.model);
    var found = tabs.get(tabName);
    if (!found) {
      found = tabs.add({name: tabName, view: view});
    }
    else {
      found.view = view;
    }

    this.regionLeftBottom.focusTab(tabName);
    found.view.blink();
    return this;
  },

  render: function () {
    var controllerView = this;
    this.renderWithTemplate();

    this.cacheElements({
      jsHeapLimit: &#039;.heap-limit span&#039;,
      jsHeapTotal: &#039;.heap-total span&#039;,
      jsHeapUsed: &#039;.heap-used span&#039;,
      detailsEl: &#039;.details&#039;
    });

    this.detailsSwitcher = new ViewSwitcher(this.detailsEl, {
      show: function (view) {
        controllerView.currentDetails = view;
      }
    });

    return this;
  },

  autoRender: true,

  /*
  :sout=#http{dst=:8080/stream} :sout-keep
  */
  template: `
    &lt;div class=&quot;controller rows&quot;&gt;
      &lt;div class=&quot;row columns gutter-horizontal header&quot;&gt;
        &lt;div class=&quot;column no-grow gutter-right&quot;&gt;Visual Fiha&lt;/div&gt;

        &lt;div class=&quot;column columns&quot;&gt;
          &lt;!-- &lt;span class=&quot;column columns no-grow button-group&quot;&gt;
            &lt;button class=&quot;column gutter-horizontal&quot; name=&quot;play&quot;&gt;&lt;span class=&quot;vfi-play&quot;&gt;&lt;/span&gt;&lt;/button&gt;
            &lt;button class=&quot;column gutter-horizontal&quot; name=&quot;pause&quot;&gt;&lt;span class=&quot;vfi-pause&quot;&gt;&lt;/span&gt;&lt;/button&gt;
            &lt;button class=&quot;column gutter-horizontal&quot; name=&quot;stop&quot;&gt;&lt;span class=&quot;vfi-stop&quot;&gt;&lt;/span&gt;&lt;/button&gt;
          &lt;/span&gt; --&gt;

          &lt;div class=&quot;column&quot;&gt;&lt;/div&gt;

          &lt;div class=&quot;column worker-performance&quot;&gt;&lt;/div&gt;

          &lt;div class=&quot;column no-grow control-screen-controls&quot;&gt;&lt;/div&gt;

          &lt;div class=&quot;column no-grow&quot;&gt;
            &lt;button name=&quot;screen&quot;&gt;Open screen&lt;/button&gt;
          &lt;/div&gt;

          &lt;div class=&quot;column&quot;&gt;&lt;/div&gt;

          &lt;div class=&quot;column no-grow&quot;&gt;
            &lt;button name=&quot;setup-editor&quot;&gt;Setup editor&lt;/button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;

      &lt;div class=&quot;row columns body&quot;&gt;
        &lt;div class=&quot;region-left column no-grow rows&quot;&gt;
          &lt;iframe class=&quot;region-left-top row control-screen&quot;&gt;&lt;/iframe&gt;

          &lt;div class=&quot;region-left-bottom row grow-l rows&quot;&gt;&lt;/div&gt;
        &lt;/div&gt;

        &lt;div class=&quot;region-right column rows settings&quot;&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  `
});
module.exports = ControllerView;</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ cyclomatic }} <br>
    Length : {{ halstead.length }} <br>
    Difficulty : {{ halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
