<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - src/web-worker.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>src/web-worker.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">68.68</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">383</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">48.27</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">2.95</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">/* jshint worker:true */
&#039;use strict&#039;;
var worker = self;
require.ensure([
  &#039;ramda&#039;,
  &#039;lodash.assign&#039;,
  &#039;ampersand-state&#039;,
  &#039;ampersand-collection&#039;
], function() {
require.ensure([
  &#039;./mapping/data&#039;,
], function() {
require.ensure([
  &#039;./layer/state&#039;,
  &#039;./layer/svg/state&#039;,
  &#039;./layer/img/state&#039;,
  &#039;./layer/txt/state&#039;,
  &#039;./layer/video/state&#039;,
  &#039;./layer/canvas/state&#039;,
], function() {
require.ensure([
  &#039;./screen/state&#039;,
], function() {
require.ensure([
  &#039;./resolve&#039;,
  &#039;./signal/collection&#039;
], function() {
// ---------------------------------------------------------------
var resolve = require(&#039;./resolve&#039;);

var Mappings = require(&#039;./mapping/data&#039;);

var ScreenState = require(&#039;./screen/state&#039;);
worker.screen = new ScreenState();

worker.layers = worker.screen.layers;

var SignalCollection = require(&#039;./signal/collection&#039;);
worker.signals = new SignalCollection({
  parent: worker.screen
});



var __dataContext = {
  frametime: 0,
  firstframetime: 0,
  audio: {},
  layers: worker.layers,
  signals: worker.signals
};


worker.mappings = new Mappings([], {
  context: __dataContext
});


function signature(fn) {
  var args = fn.toString().match(&#039;function[^(]*\\(([^)]*)\\)&#039;);
  if (!args || !args[1].trim()) { return []; }
  return args[1].split(&#039;,&#039;).map(function(a){ return a.trim(); });
}

var signatures = {};
function registerCommand(commandName, command) {
  if (arguments.length === 1) {
    if (typeof arguments[0] === &#039;function&#039;) {
      command = arguments[0];
      commandName = command.name;
    }
    else {
      command = commands[arguments[0]];
    }
  }
  else if (typeof command !== &#039;function&#039;) {
    command = commands[commandName];
  }
  signatures[commandName] = signature(command);
}



function emitCommand(name, payload) {
  worker.postMessage({
    command: name,
    payload: payload
  });
}


var screens = {};
var channel = new BroadcastChannel(&#039;spike&#039;);
function broadcastCommand(name, payload) {
  channel.postMessage({
    command: name,
    payload: payload
  });
}



/******************************************************\
 * Worker   clock                                     *
\******************************************************/
var _fps = 45;
var _prev = performance.now();
var _frameMillis = 1000 / _fps;
var _internalTimeout;
var _frameCounter = 0;
var _samplesCount = _fps * 2;
var _prevSamples = _prev;
var _animationStartTime = performance.now();

function _animate() {
  worker.screen.frametime = __dataContext.frametime = performance.now() - _animationStartTime;
  worker.signals.trigger(&#039;frametime&#039;, __dataContext.frametime);

  emitCommand(&#039;updateSignals&#039;, {
    signals: worker.signals.serialize().filter(o =&gt; o.name)
  });

  broadcastCommand(&#039;updateLayers&#039;, {
    frametime: __dataContext.frametime,
    audio: worker.audio,
    layers: worker.layers.serialize().filter(o =&gt; o.name)
  });


  var _now = performance.now();
  var elapsed = _now - _prev;
  var timeDiff = _frameMillis - (elapsed - _frameMillis);
  _prev = _now;
  _internalTimeout = setTimeout(_animate, timeDiff);

  _frameCounter++;
  if (_frameCounter === _samplesCount) {
    // inform the controller of the health of the worker
    emitCommand(&#039;health&#039;, {
      frametime: worker.screen.frametime,
      elapsed: _now - _prevSamples,
      fps: _fps,
      frameCounter: _frameCounter,
      samplesCount: _samplesCount
    });

    _frameCounter = 0;
    _prevSamples = _now;
  }
}
_internalTimeout = setTimeout(_animate, _frameMillis);


// var _bootstrapTime = Date.now();
// var _executedCommands = [];
// var _previousCommandIndex = 0;

// setInterval(function() {
//   if (_previousCommandIndex &lt; _executedCommands.length) {
//     console.info(&#039;send %s timelineCommands&#039;, _executedCommands.length - _previousCommandIndex);
//     emitCommand(&#039;timelineCommands&#039;, {
//       commands: _executedCommands.slice(_previousCommandIndex, _executedCommands.length)
//     });
//     _previousCommandIndex = _executedCommands.length;
//   }
// }, 100);


/******************************************************\
 * Screen registration                                *
\******************************************************/
channel.addEventListener(&#039;message&#039;, function(evt) {
  var command = evt.data.command;
  if (command !== &#039;register&#039;) return;

  var payload = evt.data.payload;
  if (screens[payload.id]) {
    return;
  }

  screens[payload.id] = payload.id;
});



/******************************************************\
 * Worker commands                                    *
\******************************************************/
var commands = {
  bootstrap: function(layers, signals, mappings) {
    worker.layers.set(layers);
    worker.signals.set(signals);
    worker.mappings.import(mappings, true);

    broadcastCommand(&#039;bootstrap&#039;, {
      signals: worker.signals.serialize(),
      mappings: worker.mappings.export(),
      layers: worker.layers.serialize()
    });
  },


  midi: function(deviceName, property, velocity) {
    worker.mappings.processMIDI(deviceName, property, velocity);
  },



  heartbeat: function(frametime, audio) {
    worker.frametime = frametime;
    worker.audio = audio;
  },



  propChange: function(path, property, value) {
    var obj = resolve(path, __dataContext);
    if (!obj) return;
    if (obj[property] &amp;&amp; obj[property].isCollection) {
      return obj[property].set(Array.isArray(value) ? value : [value]);
    }
    obj.set(property, value);
  },



  addMapping: function(mapping) {
    worker.mappings.add(mapping);
    emitCommand(&#039;addMapping&#039;, {mapping: mapping});
  },
  updateMapping: function(mapping) {
    var state = worker.mappings.get(mapping.name);
    if (state) state.set(mapping);
    emitCommand(&#039;updateMapping&#039;, {mapping: mapping});
  },
  removeMapping: function(name) {
    worker.mappings.remove(name);
    emitCommand(&#039;removeMapping&#039;, {name: name});
  },
  resetMappings: function(mappings) {
    worker.mappings.import(mappings, true);
  },





  resetSignals: function(signals) {
    worker.signals.reset(signals);
    emitCommand(&#039;resetSignals&#039;, {
      signals: signals
    });
  },
  addSignal: function(signal) {
    worker.signals.add(signal);
    emitCommand(&#039;addSignal&#039;, {
      signal: signal
    });
  },
  removeSignal: function(signalName) {
    var collection = worker.signals;
    collection.remove(collection.get(signalName));
    emitCommand(&#039;removeSignal&#039;, {
      signalName: signalName
    });
  },
  updateSignal: function(signal, signalName) {
    var state = worker.signals.get(signalName);
    state.set(signal);
    emitCommand(&#039;updateSignal&#039;, {
      signalName: signalName,
      signal: signal
    });
  },
  updateSignals: function(signals) {
    worker.signals.set(signals);
    emitCommand(&#039;updateSignals&#039;, {
      signals: signals
    });
  },





  resetLayers: function(layers) {
    worker.layers.reset(layers);

    broadcastCommand(&#039;resetLayers&#039;, {
      layers: layers
    });
  },
  addLayer: function(layer) {
    worker.layers.add(layer);

    broadcastCommand(&#039;addLayer&#039;, {
      layer: layer
    });
  },
  removeLayer: function(layerName) {
    var collection = worker.layers;
    collection.remove(collection.get(layerName));

    broadcastCommand(&#039;removeLayer&#039;, {
      layerName: layerName
    });
  },
  updateLayer: function(layer, broadcast) {
    var state = worker.layers.get(layer.name);
    state.set(layer);
    if (broadcast) broadcastCommand(&#039;updateLayer&#039;, {layer: layer});
  }
};



Object.keys(commands).forEach(registerCommand);





worker.addEventListener(&#039;message&#039;, function(evt) {
  var eventId = evt.data.eventId;

  var commandName = evt.data.command;
  var command = commands[commandName];


  if (typeof command !== &#039;function&#039;) {
    return worker.postMessage({
      type: &#039;error&#039;,
      command: commandName,
      message: &#039;Unknown command &quot;&#039; + commandName + &#039;&quot;&#039;,
      eventId: eventId
    });
  }

  if (!signatures[commandName]) {
    return worker.postMessage({
      type: &#039;result&#039;,
      command: commandName,
      payload: command(evt.data),
      eventId: eventId
    });
  }

  var commandArgs = signatures[commandName].map(function(argName) {
    return evt.data.payload[argName];
  });

  if ([&#039;heartbeat&#039;].indexOf(commandName) &lt; 0) {
    // _executedCommands.push({
    //   time: Date.now(),
    //   command: commandName,
    //   payload: evt.data.payload
    // });
  }
  var result = command.apply(worker, commandArgs);
  if (!eventId) return;
  worker.postMessage({
    type: &#039;result&#039;,
    command: commandName,
    payload: result,
    eventId: eventId
  });
}, {
  passive: true,
  capture: false
});

worker.layers.on(&#039;emitCommand&#039;, function(...args) {
  emitCommand(...args);
});
worker.layers.on(&#039;broadcastCommand&#039;, function(...args) {
  broadcastCommand(...args);
});
// --------------------------------------------------------------
}, &#039;worker-deps&#039;);
}, &#039;screen-state&#039;);
}, &#039;layer-state&#039;);
}, &#039;mapping-data&#039;);
}, &#039;ampersand-data&#039;);</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ cyclomatic }} <br>
    Length : {{ halstead.length }} <br>
    Difficulty : {{ halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
